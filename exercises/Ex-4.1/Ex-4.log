
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   14.1   Copyright 1985-2015 StataCorp LP
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     Special Edition                  College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

2-user Stata network perpetual license:
       Serial number:  401406206437
         Licensed to:  CRMDA
                       CRMDA

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  Maximum number of variables is set to 5000; see help set_maxvar.

. do Ex-4.1.do 

. * Paul E. Johnson
. * 20160216
. 
. capture log close

. set more off

. log using Ex-4.1.log, replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /home/pauljohn/TrueMounted/ps/ps909-multilevel/RHS/Ex-4.1/Ex-4.1.l
> og
  log type:  text
 opened on:  23 Feb 2016, 13:43:42

. 
. * London inner schools data
. * use http://www.stata-press.com/data/mlmus3/gcse, clear
. * saveold gcse.dta12, version(12)
. 
. use gcse.dta12

. 
. sum

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      school |      4,059    31.00665    18.93914          1         65
     student |      4,059    38.69993    30.26442          1        198
        gcse |      4,059   -.0011786    9.989402    -36.661     36.661
         lrt |      4,059    .0180982     9.93223     -29.35      30.16
        girl |      4,059    .6001478    .4899281          0          1
-------------+---------------------------------------------------------
     schgend |      4,059    1.804878    .9141923          1          3
      avslrt |      4,059    .0181069    3.148704    -7.5596     6.3766
       schav |      4,059    2.127125    .6530068          1          3
      vrband |      4,059    1.843065    .6308623          1          3

. 
. * RHS p. 212
. * schgend 1: mixed school 2: boys 3: girls
. 
. * Everything is better with labels
. label define schtype 1 "mixed" 2 "boys only" 3 "girls only", replace

. label values schgend schtype

. tab schgend

    schgend |      Freq.     Percent        Cum.
------------+-----------------------------------
      mixed |      2,169       53.44       53.44
  boys only |        513       12.64       66.08
 girls only |      1,377       33.92      100.00
------------+-----------------------------------
      Total |      4,059      100.00

. 
. 
. * From RHS p. 212
. mixed gcse i.schgend##c.lrt || school: lrt, covariance(unstructured) mle

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13998.825  
Iteration 1:   log likelihood = -13998.825  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(5)      =     803.89
Log likelihood = -13998.825                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     schgend |
  boys only  |   .8546715   1.085021     0.79   0.431    -1.271931    2.981274
 girls only  |    2.43341   .8433413     2.89   0.004     .7804919    4.086329
             |
         lrt |   .5712361   .0271256    21.06   0.000     .5180708    .6244014
             |
     schgend#|
       c.lrt |
  boys only  |  -.0230098   .0573895    -0.40   0.688    -.1354911    .0894716
 girls only  |   -.029544   .0447032    -0.66   0.509    -.1171606    .0580726
             |
       _cons |  -.9976073    .506809    -1.97   0.049    -1.990935   -.0042799
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                    var(lrt) |   .0143797   .0045359      .0077491     .026684
                  var(_cons) |   7.828436   1.615416      5.224294    11.73066
              cov(lrt,_cons) |   .2002265   .0663294      .0702232    .3302298
-----------------------------+------------------------------------------------
               var(Residual) |   55.38086   1.249724      52.98482    57.88524
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 381.45                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * I noticed mixed has different output format than xtmixed
. 
. mixed gcse i.schgend##c.lrt || school: lrt, /// 
>    covariance(unstructured) mle stddev

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13998.825  
Iteration 1:   log likelihood = -13998.825  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(5)      =     803.89
Log likelihood = -13998.825                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     schgend |
  boys only  |   .8546715   1.085021     0.79   0.431    -1.271931    2.981274
 girls only  |    2.43341   .8433413     2.89   0.004     .7804919    4.086329
             |
         lrt |   .5712361   .0271256    21.06   0.000     .5180708    .6244014
             |
     schgend#|
       c.lrt |
  boys only  |  -.0230098   .0573895    -0.40   0.688    -.1354911    .0894716
 girls only  |   -.029544   .0447032    -0.66   0.509    -.1171606    .0580726
             |
       _cons |  -.9976073    .506809    -1.97   0.049    -1.990935   -.0042799
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1199154   .0189129      .0880287    .1633525
                   sd(_cons) |   2.797934     .28868      2.285672    3.425005
             corr(lrt,_cons) |   .5967727   .1381314      .2614253    .8035676
-----------------------------+------------------------------------------------
                sd(Residual) |   7.441831   .0839662      7.279067    7.608235
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 381.45                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. 
. 
. * Make some plots. 
. 
. egen pickone = tag(school)

. 
. twoway (scatter gcse lrt), by(schgend)

. 
. twoway (scatter gcse lrt) , by(schgend, compact legend(off))

. gsort +school +lrt

. predict gcsefit, fitted

. * Note difference from "fitted" and "xb" there.  "fitted" includes
. * random effects
. 
. * Trellis plot
. twoway (scatter gcse lrt, msymbol(smcircle_hollow) mlwidth(vvthin)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     by(school, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

. 
. * omit the by for spaghetti
. twoway (scatter gcse lrt)(line gcsefit lrt, connect(ascending)), ///
>                 xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predic
> ted"))

. 
. 
. twoway (scatter gcse lrt, msize(small) msymbol(smcircle_hollow) mlwidth(vvthi
> n)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

. * I'm sorry to say that Stata makes this so tedious to color code the 
. * dots with the school type that I'm stopping in anger.
. 
. 
. * Trellis plot.
. twoway (scatter gcse lrt) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     by(schgend, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

.                                                
. twoway (scatter gcse lrt, ///
>     msize(small) msymbol(smcircle_hollow) mlwidth(vvthin)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     by(schgend, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

.                                                
. 
. * 4.1.2 
. * Asks us to consider girl as a fixed predictor that interacts with the
. * school type. Of course, the bad problem is that we have all girls and 
. * all boys schools, and we can't look for an interaction there. We can
. * only look in the mixed ones. 
. 
. * Insert girl as dichotomous predictor to get started
. mixed gcse i.schgend##c.lrt i.girl || school: lrt, ///
>     covariance(unstructured) mle

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.604  
Iteration 1:   log likelihood = -13986.604  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(6)      =     823.16
Log likelihood = -13986.604                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     schgend |
  boys only  |   1.665861   1.103862     1.51   0.131    -.4976696    3.829391
 girls only  |   1.568706   .8664248     1.81   0.070    -.1294558    3.266867
             |
         lrt |   .5638984     .02724    20.70   0.000      .510509    .6172878
             |
     schgend#|
       c.lrt |
  boys only  |   -.015932   .0575571    -0.28   0.782    -.1287419    .0968778
 girls only  |   -.022419   .0448568    -0.50   0.617    -.1103368    .0654987
             |
      1.girl |   1.676371   .3384293     4.95   0.000     1.013062     2.33968
       _cons |  -1.810188   .5357075    -3.38   0.001    -2.860156    -.760221
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                    var(lrt) |   .0145709   .0045633      .0078869    .0269195
                  var(_cons) |   7.946854   1.634542      5.310269    11.89252
              cov(lrt,_cons) |   .2004185   .0668185      .0694566    .3313803
-----------------------------+------------------------------------------------
               var(Residual) |   55.01891   1.241702      52.63826    57.50723
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.20                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * Output from this makes you think you made an error because there are
. * so many aliased coefficients
. mixed gcse i.schgend##c.lrt##i.girl || school: lrt, ///
>     covariance(unstructured) mle stddev
note: 2.schgend#1.girl identifies no observations in the sample
note: 3.schgend#0.girl identifies no observations in the sample
note: 3.schgend#1.girl omitted because of collinearity
note: 2.schgend#1.girl#c.lrt identifies no observations in the sample
note: 3.schgend#0.girl#c.lrt identifies no observations in the sample
note: 3.schgend#1.girl#c.lrt omitted because of collinearity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.509  
Iteration 1:   log likelihood = -13986.509  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(7)      =     822.99
Log likelihood = -13986.509                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     schgend |
  boys only  |   1.671756    1.10358     1.51   0.130    -.4912206    3.834733
 girls only  |   1.574159   .8662123     1.82   0.069    -.1235864    3.271903
             |
         lrt |   .5575882   .0308811    18.06   0.000     .4970625     .618114
             |
     schgend#|
       c.lrt |
  boys only  |  -.0096202     .05938    -0.16   0.871    -.1260029    .1067625
 girls only  |  -.0309505   .0489599    -0.63   0.527    -.1269101    .0650092
             |
      1.girl |   1.677041   .3384244     4.96   0.000     1.013741    2.340341
             |
schgend#girl |
boys only#1  |          0  (empty)
 girls only #|
          0  |          0  (empty)
 girls only #|
          1  |          0  (omitted)
             |
  girl#c.lrt |
          1  |   .0148526    .034126     0.44   0.663    -.0520331    .0817383
             |
     schgend#|
  girl#c.lrt |
boys only#1  |          0  (empty)
 girls only #|
          0  |          0  (empty)
 girls only #|
          1  |          0  (omitted)
             |
       _cons |  -1.816403   .5357118    -3.39   0.001    -2.866378   -.7664268
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207742   .0189007      .0888719    .1641285
                   sd(_cons) |   2.817896   .2898336      2.303429    3.447267
             corr(lrt,_cons) |   .5910903   .1384768      .2563335    .7992384
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417402      .0837      7.255154    7.583279
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.27                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

.  
. * That's really messy.   Too many aliased coefficients.
. * It looks to me like you have to piece that together.
. * The slope for "lrt" is the mixed schools slope for boys
. 
. *  To clean it up, manufacture some dummy variables for school type.
. 
. * Basically, we need to get 4 lines out:
. * boys schools (intercept and lrt slope)
. * girls schools (intercept and lrt slope)
. * boys in mixed schools (just intercept, not diff slope of lrt)
. * girls in mixed schools (ditto).
. * a slope estimate for lrt in mixed schools.  Note question does not
. * say allow slope to differe between boys and girls within mixed schools.
. 
. * Is just dummy coding nonsense.
.  
. * RECODE/Create dummy variables
. * Here's the smart way to way to create dummies for a categorical variable
. * RHS p. 43: This creates schgend1 schgend2 schgend3
. tab schgend, generate(schgend)

    schgend |      Freq.     Percent        Cum.
------------+-----------------------------------
      mixed |      2,169       53.44       53.44
  boys only |        513       12.64       66.08
 girls only |      1,377       33.92      100.00
------------+-----------------------------------
      Total |      4,059      100.00

. * Don't do this
. * gen mixedsch = schgend
. * recode mixedsch 1=1 2=0 3=0
. * gen boyschool = schgend
. * recode boyschool 1=0 2=1 3=0
. 
. generate boy = 1-girl

. 
. mixed gcse i.schgend1#i.girl i.schgend2 i.schgend3 ///
>     lrt i.schgend2#c.lrt i.schgend3#c.lrt ///
>     || school: lrt, covariance(unstructured) mle stddev
note: 0.schgend1#1.girl omitted because of collinearity
note: 1.schgend1#1.girl omitted because of collinearity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.604  
Iteration 1:   log likelihood = -13986.604  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(6)      =     823.16
Log likelihood = -13986.604                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    schgend1#|
        girl |
        0 1  |          0  (omitted)
        1 0  |  -1.676371   .3384293    -4.95   0.000     -2.33968   -1.013062
        1 1  |          0  (omitted)
             |
  1.schgend2 |  -.0105102   1.105453    -0.01   0.992    -2.177159    2.156139
  1.schgend3 |   1.568706   .8664248     1.81   0.070    -.1294558    3.266867
         lrt |   .5638984     .02724    20.70   0.000      .510509    .6172878
             |
    schgend2#|
       c.lrt |
          1  |   -.015932   .0575571    -0.28   0.782    -.1287419    .0968778
             |
    schgend3#|
       c.lrt |
          1  |   -.022419   .0448568    -0.50   0.617    -.1103368    .0654987
             |
       _cons |  -.1338175   .5389784    -0.25   0.804    -1.190196    .9225608
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207099   .0189021      .0888081    .1640716
                   sd(_cons) |   2.819017   .2899136      2.304402    3.448554
             corr(lrt,_cons) |   .5889754   .1387669      .2539768    .7978006
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417473   .0837011      7.255223    7.583352
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.20                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. * Which cases are "in" is the constant in that model?
. 
. * Another way to fit: suppress the constant
. mixed gcse i.schgend1#i.girl i.schgend2 i.schgend3 ///
>     lrt i.schgend2#c.lrt i.schgend3#c.lrt, noconstant ///
>     || school: lrt, covariance(unstructured) mle stddev
note: 0.schgend1#1.girl omitted because of collinearity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.604  
Iteration 1:   log likelihood = -13986.604  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(7)      =    1012.59
Log likelihood = -13986.604                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    schgend1#|
        girl |
        0 1  |          0  (omitted)
        1 0  |  -1.810188   .5357075    -3.38   0.001    -2.860156    -.760221
        1 1  |  -.1338175   .5389784    -0.25   0.804    -1.190196    .9225608
             |
  1.schgend2 |  -.1443277   .9651578    -0.15   0.881    -2.036002    1.747347
  1.schgend3 |   1.434888   .6783762     2.12   0.034     .1052953    2.764481
         lrt |   .5638984     .02724    20.70   0.000      .510509    .6172878
             |
    schgend2#|
       c.lrt |
          1  |   -.015932   .0575571    -0.28   0.782    -.1287419    .0968778
             |
    schgend3#|
       c.lrt |
          1  |   -.022419   .0448568    -0.50   0.617    -.1103368    .0654987
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207099   .0189021      .0888081    .1640716
                   sd(_cons) |   2.819017   .2899136      2.304402    3.448554
             corr(lrt,_cons) |   .5889754   .1387669      .2539768    .7978006
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417473   .0837011      7.255223    7.583352
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.20                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * RHS use lincom, which I can't get to work with factor variables.
. 
. * They ask if girls do better in same sex school, why not
. * estimate that directly
. 
. mixed gcse i.girl i.schgend1#i.girl i.schgend2 ///
>     lrt i.schgend2#c.lrt i.schgend3#c.lrt, noconstant ///
>     || school: lrt, covariance(unstructured) mle stddev

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.604  
Iteration 1:   log likelihood = -13986.604  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(7)      =    1012.59
Log likelihood = -13986.604                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      1.girl |   1.434888   .6783762     2.12   0.034     .1052953    2.764481
             |
    schgend1#|
        girl |
        1 0  |  -1.810188   .5357075    -3.38   0.001    -2.860156    -.760221
        1 1  |  -1.568706   .8664248    -1.81   0.070    -3.266867    .1294558
             |
  1.schgend2 |  -.1443277   .9651578    -0.15   0.881    -2.036002    1.747347
         lrt |   .5638984     .02724    20.70   0.000      .510509    .6172878
             |
    schgend2#|
       c.lrt |
          1  |   -.015932   .0575571    -0.28   0.782    -.1287419    .0968778
             |
    schgend3#|
       c.lrt |
          1  |   -.022419   .0448568    -0.50   0.617    -.1103368    .0654987
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207099   .0189021      .0888081    .1640716
                   sd(_cons) |   2.819017   .2899136      2.304402    3.448554
             corr(lrt,_cons) |   .5889754   .1387669      .2539768    .7978006
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417473   .0837011      7.255223    7.583352
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.20                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * Can use same trick to see boy difference in 2 types of schools
. mixed gcse i.boy i.schgend1#i.boy i.schgend3 ///
>     lrt i.schgend2#c.lrt i.schgend3#c.lrt, noconstant ///
>     || school: lrt, covariance(unstructured) mle stddev

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.604  
Iteration 1:   log likelihood = -13986.604  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(7)      =    1012.59
Log likelihood = -13986.604                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       1.boy |  -.1443277   .9651578    -0.15   0.881    -2.036002    1.747347
             |
schgend1#boy |
        1 0  |  -.1338175   .5389784    -0.25   0.804    -1.190196    .9225608
        1 1  |  -1.665861   1.103862    -1.51   0.131    -3.829391    .4976696
             |
  1.schgend3 |   1.434888   .6783762     2.12   0.034     .1052953    2.764481
         lrt |   .5638984     .02724    20.70   0.000      .510509    .6172878
             |
    schgend2#|
       c.lrt |
          1  |   -.015932   .0575571    -0.28   0.782    -.1287419    .0968778
             |
    schgend3#|
       c.lrt |
          1  |   -.022419   .0448568    -0.50   0.617    -.1103368    .0654987
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207099   .0189021      .0888081    .1640716
                   sd(_cons) |   2.819017   .2899136      2.304402    3.448554
             corr(lrt,_cons) |   .5889754   .1387669      .2539768    .7978006
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417473   .0837011      7.255223    7.583352
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.20                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. 
. mixed gcse i.schgend1#c.lrt i.schgend2#c.lrt c.lrt i.schgend1 ///
>    i.girl#i.schgend1 i.girl, noconstant || school: lrt, /// 
>    covariance(unstructured) mle 

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.615  
Iteration 1:   log likelihood = -13986.615  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(6)      =    1012.97
Log likelihood = -13986.615                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    schgend1#|
       c.lrt |
          1  |   .0224169   .0448386     0.50   0.617     -.065465    .1102989
             |
    schgend2#|
       c.lrt |
          1  |   .0098713   .0576742     0.17   0.864    -.1031681    .1229108
             |
         lrt |   .5414828   .0356239    15.20   0.000     .4716613    .6113043
  1.schgend1 |  -1.810109   .5357083    -3.38   0.001    -2.860078   -.7601404
             |
        girl#|
    schgend1 |
        1 1  |   .2414105   .7581088     0.32   0.750    -1.244455    1.727276
             |
      1.girl |   1.434967   .6783752     2.12   0.034     .1053756    2.764558
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                    var(lrt) |    .014551   .0045576      .0078755    .0268846
                  var(_cons) |   7.946859   1.634871      5.309844    11.89349
              cov(lrt,_cons) |   .2001701   .0667801      .0692836    .3310567
-----------------------------+------------------------------------------------
               var(Residual) |   55.01959   1.241721       52.6389    57.50795
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.56                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. 
. * I wondered why we did not check for lrt slope difference between
. * boys and girls within mixed schools. How to do that?
. 
. 
. mixed gcse  i1.schgend1#i.girl i1.schgend2 i1.schgend3 ///
>     c.lrt#i1.schgend1#i.girl ///
>     i1.schgend2#c.lrt i1.schgend3#c.lrt, /// 
>     noconstant ///
>     || school: lrt, covariance(unstructured) mle stddev

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.509  
Iteration 1:   log likelihood = -13986.509  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(8)      =    1014.07
Log likelihood = -13986.509                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    schgend1#|
        girl |
        1 0  |  -1.816403   .5357118    -3.39   0.001    -2.866378   -.7664268
        1 1  |  -.1393615     .53894    -0.26   0.796    -1.195664    .9169414
             |
  1.schgend2 |  -.1446466   .9648322    -0.15   0.881    -2.035683     1.74639
  1.schgend3 |   1.434797   .6781353     2.12   0.034     .1056762    2.763918
             |
    schgend1#|
  girl#c.lrt |
        1 0  |   .5575882   .0308811    18.06   0.000     .4970625     .618114
        1 1  |   .5724408    .033559    17.06   0.000     .5066663    .6382153
             |
    schgend2#|
       c.lrt |
          1  |    .547968   .0507183    10.80   0.000     .4485619    .6473741
             |
    schgend3#|
       c.lrt |
          1  |   .5414903   .0356492    15.19   0.000     .4716193    .6113614
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207742   .0189007      .0888719    .1641285
                   sd(_cons) |   2.817896   .2898336      2.303429    3.447267
             corr(lrt,_cons) |   .5910903   .1384768      .2563335    .7992384
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417402      .0837      7.255154    7.583279
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.27                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * Inserting the i1. notation cleaned up the output quite a bit.
. 
. * Before I realized that would work, I was following the RHS strategy
. * of manually recoding interactions.
. generate s1boy = schgend1 * (1 - girl)

. generate s1girl = schgend1 * girl

. 
. xtmixed gcse  i.s1girl i.s1boy  i.schgend2 i.schgend3 ///
>     c.lrt#i.s1girl c.lrt#i.s1boy i.schgend2#c.lrt i.schgend3#c.lrt, noconstan
> t ///
>     || school: lrt, covariance(unstructured) mle stddev 
note: 1.s1boy#c.lrt omitted because of collinearity
note: 1.schgend2#c.lrt omitted because of collinearity
note: 0.schgend3#c.lrt omitted because of collinearity
note: 1.schgend3#c.lrt omitted because of collinearity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.509  
Iteration 1:   log likelihood = -13986.509  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(8)      =    1014.07
Log likelihood = -13986.509                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    1.s1girl |  -.1393615     .53894    -0.26   0.796    -1.195664    .9169414
     1.s1boy |  -1.816403   .5357118    -3.39   0.001    -2.866378   -.7664268
  1.schgend2 |  -.1446466   .9648322    -0.15   0.881    -2.035683     1.74639
  1.schgend3 |   1.434797   .6781353     2.12   0.034     .1056762    2.763918
             |
s1girl#c.lrt |
          0  |   .5640659   .0692593     8.14   0.000     .4283201    .6998116
          1  |   .5950163   .1032033     5.77   0.000     .3927417     .797291
             |
 s1boy#c.lrt |
          0  |  -.0160979   .0471646    -0.34   0.733    -.1085388    .0763431
          1  |          0  (omitted)
             |
    schgend2#|
       c.lrt |
          0  |  -.0064776   .0619936    -0.10   0.917    -.1279829    .1150276
          1  |          0  (omitted)
             |
    schgend3#|
       c.lrt |
          0  |          0  (omitted)
          1  |          0  (omitted)
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207742   .0189007      .0888719    .1641285
                   sd(_cons) |   2.817896   .2898336      2.303429    3.447267
             corr(lrt,_cons) |   .5910903   .1384768      .2563335    .7992384
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417402      .0837      7.255154    7.583279
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.27                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. 
. * That still kinda messy. Manufacture more dummies to un-confuse Stata
. generate s1boylrt = lrt*boy*schgend1

. generate s1girllrt = lrt*girl*schgend1

. xtmixed gcse  i.s1girl i.s1boy  i.schgend2 i.schgend3 ///
>      s1boylrt s1girllrt i1.schgend2#c.lrt i.schgend3#c.lrt, noconstant ///
>     || school: lrt, covariance(unstructured) mle stddev 
note: 0.schgend3#c.lrt omitted because of collinearity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.509  
Iteration 1:   log likelihood = -13986.509  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(8)      =    1014.07
Log likelihood = -13986.509                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    1.s1girl |  -.1393615     .53894    -0.26   0.796    -1.195664    .9169414
     1.s1boy |  -1.816403   .5357118    -3.39   0.001    -2.866378   -.7664268
  1.schgend2 |  -.1446466   .9648322    -0.15   0.881    -2.035683     1.74639
  1.schgend3 |   1.434797   .6781353     2.12   0.034     .1056762    2.763918
    s1boylrt |   .5575882   .0308811    18.06   0.000     .4970625     .618114
   s1girllrt |   .5724408    .033559    17.06   0.000     .5066663    .6382153
             |
    schgend2#|
       c.lrt |
          1  |    .547968   .0507183    10.80   0.000     .4485619    .6473741
             |
    schgend3#|
       c.lrt |
          0  |          0  (omitted)
          1  |   .5414903   .0356492    15.19   0.000     .4716193    .6113614
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207742   .0189007      .0888719    .1641285
                   sd(_cons) |   2.817896   .2898336      2.303429    3.447267
             corr(lrt,_cons) |   .5910903   .1384768      .2563335    .7992384
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417402      .0837      7.255154    7.583279
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.27                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * Maybe leave lrt in, treat all variationts against it
. xtmixed gcse  i.s1girl i.s1boy  i.schgend2 i.schgend3 ///
>      lrt s1girllrt i1.schgend2#c.lrt i.schgend3#c.lrt, noconstant ///
>     || school: lrt, covariance(unstructured) mle stddev 

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.509  
Iteration 1:   log likelihood = -13986.509  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(8)      =    1014.07
Log likelihood = -13986.509                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    1.s1girl |  -.1393615     .53894    -0.26   0.796    -1.195664    .9169414
     1.s1boy |  -1.816403   .5357118    -3.39   0.001    -2.866378   -.7664268
  1.schgend2 |  -.1446466   .9648322    -0.15   0.881    -2.035683     1.74639
  1.schgend3 |   1.434797   .6781353     2.12   0.034     .1056762    2.763918
         lrt |   .5575882   .0308811    18.06   0.000     .4970625     .618114
   s1girllrt |   .0148526    .034126     0.44   0.663    -.0520331    .0817383
             |
    schgend2#|
       c.lrt |
          1  |  -.0096202     .05938    -0.16   0.871    -.1260029    .1067625
             |
    schgend3#|
       c.lrt |
          1  |  -.0160979   .0471646    -0.34   0.733    -.1085388    .0763431
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207742   .0189007      .0888719    .1641285
                   sd(_cons) |   2.817896   .2898336      2.303429    3.447267
             corr(lrt,_cons) |   .5910903   .1384768      .2563335    .7992384
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417402      .0837      7.255154    7.583279
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.27                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. 
. 
. clear all

. use gcse.dta12

. 
. * HOW RHS did their homework:
. tabulate schgend, generate(w)

    schgend |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      2,169       53.44       53.44
          2 |        513       12.64       66.08
          3 |      1,377       33.92      100.00
------------+-----------------------------------
      Total |      4,059      100.00

. rename w2 boys

. rename w3 girls

. generate boys_lrt = boys*lrt

. generate girls_lrt = girls*lrt

. xtmixed gcse lrt boys girls boys_lrt girls_lrt || school: lrt, ///
>    cov(unstructured) mle

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13998.825  
Iteration 1:   log likelihood = -13998.825  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(5)      =     803.89
Log likelihood = -13998.825                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         lrt |   .5712361   .0271256    21.06   0.000     .5180708    .6244014
        boys |   .8546715   1.085021     0.79   0.431    -1.271931    2.981274
       girls |    2.43341   .8433413     2.89   0.004     .7804919    4.086329
    boys_lrt |  -.0230098   .0573895    -0.40   0.688    -.1354911    .0894716
   girls_lrt |   -.029544   .0447032    -0.66   0.509    -.1171606    .0580726
       _cons |  -.9976073    .506809    -1.97   0.049    -1.990935   -.0042799
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1199154   .0189129      .0880287    .1633525
                   sd(_cons) |   2.797934     .28868      2.285672    3.425005
             corr(lrt,_cons) |   .5967727   .1381314      .2614253    .8035676
-----------------------------+------------------------------------------------
                sd(Residual) |   7.441831   .0839662      7.279067    7.608235
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 381.45                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. generate boy = 1-girl

. rename w1 mixed

. generate boy_mixed = boy*mixed

. generate girl_mixed = girl*mixed

. xtmixed gcse boy_mixed girl_mixed boys girls lrt boys_lrt girls_lrt, ///
>    noconstant || school: lrt, cov(unstructured) mle

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13986.604  
Iteration 1:   log likelihood = -13986.604  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(7)      =    1012.59
Log likelihood = -13986.604                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   boy_mixed |  -1.810188   .5357075    -3.38   0.001    -2.860156    -.760221
  girl_mixed |  -.1338175   .5389784    -0.25   0.804    -1.190196    .9225608
        boys |  -.1443277   .9651578    -0.15   0.881    -2.036002    1.747347
       girls |   1.434888   .6783762     2.12   0.034     .1052953    2.764481
         lrt |   .5638984     .02724    20.70   0.000      .510509    .6172878
    boys_lrt |   -.015932   .0575571    -0.28   0.782    -.1287419    .0968778
   girls_lrt |   -.022419   .0448568    -0.50   0.617    -.1103368    .0654987
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1207099   .0189021      .0888081    .1640716
                   sd(_cons) |   2.819017   .2899136      2.304402    3.448554
             corr(lrt,_cons) |   .5889754   .1387669      .2539768    .7978006
-----------------------------+------------------------------------------------
                sd(Residual) |   7.417473   .0837011      7.255223    7.583352
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 391.20                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. lincom girls - girl_mixed

 ( 1)  - [gcse]girl_mixed + [gcse]girls = 0

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.568706   .8664248     1.81   0.070    -.1294558    3.266867
------------------------------------------------------------------------------

. 
end of do-file
